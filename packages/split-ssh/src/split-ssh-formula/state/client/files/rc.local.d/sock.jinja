
# Create split-SSH socket
#
# See /srv/user_salt/split-ssh in dom0 for details.
{% set tags = pillar.get('qubes').get('tags') -%}
{% for tag in tags -%}
  {%- if tag.startswith('split-ssh-vault-is-') -%}
    {%- set vault = tag[19:] -%}
SSH_VAULT_VM={{ vault }}
  {%- endif -%}
{%- endfor %}

if [ "$SSH_VAULT_VM" != "" ]; then
	export SSH_SOCK=/home/user/.SSH_AGENT_$SSH_VAULT_VM
	rm -f "$SSH_SOCK"
	sudo -u user /bin/sh -c "umask 117 && ncat -k -l -U '$SSH_SOCK' -c 'qrexec-client-vm $SSH_VAULT_VM qubes.SSHAgent' &"
fi
